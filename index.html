<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aplikasi Monitoring Kapal BAKAMLA RI</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- PapaParse (parser CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- SheetJS (untuk ekspor Excel lokal) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f2f5f9; }
    header { background: #003366; color: #fff; padding: 12px 20px; }
    header h1 { margin: 0; font-size: 30px; }
    main { display: flex; height: calc(100vh - 60px); }
    aside { width: 280px; background: #fff; border-right: 1px solid #ddd; padding: 10px; overflow-y: auto; }
    #map { flex: 1; min-height: 100%; }
    .info-panel { padding: 10px; background: #fff; border-top: 1px solid #ddd; }
    .stat { margin-bottom: 8px; }
    .stat span { font-weight: bold; color: #003366; }
    ul { list-style: none; padding: 0; }
    li { padding: 6px; border-bottom: 1px solid #eee; cursor: pointer; }
    li:hover { background: #f0f4ff; }
    .chart-container { background: #fff; padding: 10px; border-top: 1px solid #ddd; }
    .coord-input, .supply-input { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .coord-input input, .supply-input input { flex: 1; padding: 4px; }
    button { padding: 6px 10px; background: #003366; color: #fff; border: none; cursor: pointer; margin-top: 5px; }
    button:hover { background: #0055aa; }
    .log-container { background: #fff; padding: 10px; border-top: 1px solid #ddd; max-height: 200px; overflow-y:auto; }
    .log-entry { font-size: 13px; border-bottom: 1px solid #eee; padding: 4px 0; }
    .log-entry span { font-weight: bold; color: #2563eb; }
    .log-header { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    select { padding: 4px; }

    /* Responsive HP/Tablet */
    @media (max-width: 768px) {
      main { flex-direction: column; }
      aside { width: 100%; border-right: none; border-bottom: 1px solid #ddd; }
      #map { height: 40vh; }
      .chart-container { height: 25vh; }
      .log-container { max-height: 30vh; }
    }
  </style>
</head>
<body>
  <header>
    <div style="text-align:center;">
      <h1>Monitoring Kapal BAKAMLA RI</h1>
      <img src="img/Logo-Bakamla.jpg" alt="BAKAMLA RI" style="height:40px;vertical-align:middle;">
    </div>
  </header>

  <main>
    <!-- Sidebar daftar kapal -->
    <aside>
      <h2>Daftar Kapal</h2>
      <ul id="shipList"></ul>
    </aside>

    <!-- Area peta + detail -->
    <section style="flex:1;display:flex;flex-direction:column;">
      <div id="map"></div>

      <div class="info-panel">
        <h3>Detail Kapal</h3>
        <div class="stat">Nama Kapal: <span id="shipName">-</span></div>
        <div class="stat">Posisi: <span id="shipPosition">-</span></div>
        <div class="stat">Bahan Bakar: <span id="shipFuel">-</span></div>
        <div class="stat">Air Tawar: <span id="shipWater">-</span></div>
        <div class="stat">Minyak Pelumas: <span id="shipLube">-</span></div>
        <div class="stat">Jumlah Personil: <span id="shipCrew">-</span></div>

        <!-- Form input koordinat manual (DMS) -->
        <h4>Update Posisi Manual</h4>
        <div class="coord-input">
          <label>Lintang:</label>
          <input type="number" id="latDeg" placeholder="°" style="width:60px;" />
          <input type="number" id="latMin" placeholder="’" style="width:60px;" />
          <input type="number" id="latSec" placeholder="”" style="width:80px;" />
          <select id="latDir"><option value="N">N</option><option value="S">S</option></select>
        </div>
        <div class="coord-input">
          <label>Bujur:</label>
          <input type="number" id="lngDeg" placeholder="°" style="width:60px;" />
          <input type="number" id="lngMin" placeholder="’" style="width:60px;" />
          <input type="number" id="lngSec" placeholder="”" style="width:80px;" />
          <select id="lngDir"><option value="E">E</option><option value="W">W</option></select>
        </div>
        <button onclick="updatePositionDMS()">Update</button>

        <!-- Form input logistik manual -->
        <h4>Update Data Logistik</h4>
        <div class="supply-input">
          <input type="number" id="inputFuel" placeholder="Bahan Bakar (L)" />
          <input type="number" id="inputWater" placeholder="Air Tawar (L)" />
          <input type="number" id="inputLube" placeholder="Pelumas (L)" />
          <input type="number" id="inputCrew" placeholder="Personil" />
          <button onclick="updateSuppliesManual()">Update</button>
        </div>

        <!-- Form input aktivitas -->
        <h4>Catat Aktivitas</h4>
        <div class="supply-input">
          <select id="presetActivity">
            <option value="">-- Pilih Aktivitas --</option>
            <option value="Pemeriksaan">Pemeriksaan</option>
            <option value="Penahanan">Penahanan</option>
            <option value="Perbaikan">Perbaikan</option>
            <option value="Latihan">Latihan</option>
            <option value="Patroli">Patroli</option>
          </select>
          <input type="text" id="inputActivity" placeholder="Atau ketik aktivitas lain..." />
          <button onclick="addActivity()">Simpan Aktivitas</button>
        </div>
      </div>

      <!-- Chart panel -->
      <div class="chart-container">
        <h3>Grafik Ketersediaan</h3>
        <canvas id="supplyChart"></canvas>
      </div>

      <!-- Log aktivitas -->
      <div class="log-container" id="logContainer">
        <div class="log-header">
          <h3>Riwayat Aktivitas</h3>
          <div>
            <select id="logFilter" onchange="renderLogs()">
              <option value="all">Semua Kapal</option>
            </select>
            <button onclick="downloadLogCSV()">CSV</button>
            <button onclick="downloadLogExcel()">Excel</button>
          </div>
        </div>
        <div id="logList"></div>
      </div>
    </section>
  </main>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ==========================================
    // 1) DATA AWAL KAPAL (akan diupdate dari Sheet)
    // ==========================================
    const ships = [
      { id: 1, name: "KN TANJUNG DATU 1101", lat: -6.2, lng: 106.8, fuel: 8000, water: 3000, lube: 1200, crew: 40 },
      { id: 2, name: "KN PULAU NIPAH 321",   lat: -5.8, lng: 107.0, fuel: 6000, water: 2500, lube: 1000, crew: 35 },
      { id: 3, name: "KN PULAU MARORE 322",   lat: -6.4, lng: 107.2, fuel: 9000, water: 3500, lube: 1400, crew: 45 },
      { id: 4, name: "KN PULAU DANA 323",     lat: -6.0, lng: 107.2, fuel: 9000, water: 3500, lube: 1400, crew: 45 },
      { id: 5, name: "KN BINTANG LAUT 401",   lat: -5.5, lng: 107.2, fuel: 9000, water: 3500, lube: 1400, crew: 45 },
      { id: 6, name: "KN SINGA LAUT 402",     lat: -6.9, lng: 107.2, fuel: 9000, water: 3500, lube: 1400, crew: 45 },
      { id: 7, name: "KN KUDA LAUT 403",      lat: -5.1, lng: 107.2, fuel: 9000, water: 3500, lube: 1400, crew: 45 },
      { id: 8, name: "KN GAJAH LAUT 404",     lat: -5.9, lng: 107.2, fuel: 9000, water: 3500, lube: 1400, crew: 45 },
      { id: 9, name: "KN ULAR LAUT 405",      lat: -4.7, lng: 107.2, fuel: 9000, water: 3500, lube: 1400, crew: 45 },
      { id:10, name: "KN BELUT LAUT 406",     lat: -4.4, lng: 107.2, fuel: 9000, water: 3500, lube: 1400, crew: 45 }
    ];

    // ==========================================
    // 2) KONFIGURASI SHEET (CSV PUBLIK)
    // ==========================================
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQXPdMlJVGFfVxVQk86s71Kdhid_qpp69mnSo95GPyOfdyR3FxjY6je96CWTe5NUizUoGf0TxGguyiq/pub?output=csv";

    // ==========================================
    // 3) PETA & MARKER
    // ==========================================
    let currentShipId = null;
    const logs = [];
    const seenSheetLogs = new Set();  // anti duplikasi log dari Sheet

    const map = L.map("map").setView([-6.2, 106.8], 8);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const markers = {};
    const shipList = document.getElementById("shipList");
    const logFilter = document.getElementById("logFilter");

    ships.forEach(ship => {
      const li = document.createElement("li");
      li.textContent = ship.name;
      li.onclick = () => focusShip(ship.id);
      shipList.appendChild(li);

      const marker = L.marker([ship.lat, ship.lng]).addTo(map).bindPopup(ship.name);
      markers[ship.id] = marker;

      const opt = document.createElement("option");
      opt.value = ship.id;
      opt.textContent = ship.name;
      logFilter.appendChild(opt);
    });

    // ==========================================
    // 4) CHART
    // ==========================================
    const ctx = document.getElementById("supplyChart").getContext("2d");
    const supplyChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["Bahan Bakar", "Air Tawar", "Minyak Pelumas"],
        datasets: [{
          label: "Ketersediaan (Liter)",
          data: [0, 0, 0],
          backgroundColor: ["#2563eb", "#0ea5e9", "#f59e0b"]
        }]
      },
      options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    // ==========================================
    // 5) UTIL & RENDER
    // ==========================================
    function addLog(shipId, text, timeOpt) {
      const time = timeOpt || new Date().toLocaleTimeString();
      logs.unshift({ shipId, time, text });
      renderLogs();
    }

    function renderLogs() {
      const logList = document.getElementById("logList");
      const filter = logFilter.value;
      const filteredLogs = logs.filter(l => filter === "all" || l.shipId == filter);
      logList.innerHTML = filteredLogs
        .map(l => `<div class="log-entry">[${l.time}] <span>${ships.find(s => s.id === l.shipId).name}</span> - ${l.text}</div>`)
        .join("");
    }

    function updateShipDetails(ship) {
      if (!ship) return;
      document.getElementById("shipName").textContent = ship.name;
      document.getElementById("shipPosition").textContent = `${ship.lat.toFixed(4)}, ${ship.lng.toFixed(4)}`;
      document.getElementById("shipFuel").textContent = ship.fuel + " L";
      document.getElementById("shipWater").textContent = ship.water + " L";
      document.getElementById("shipLube").textContent = ship.lube + " L";
      document.getElementById("shipCrew").textContent = ship.crew + " orang";

      document.getElementById("inputFuel").value = ship.fuel;
      document.getElementById("inputWater").value = ship.water;
      document.getElementById("inputLube").value = ship.lube;
      document.getElementById("inputCrew").value = ship.crew;

      supplyChart.data.datasets[0].data = [ship.fuel, ship.water, ship.lube];
      supplyChart.update();
    }

    function focusShip(id) {
      const ship = ships.find(s => s.id === id);
      if (!ship) return;
      currentShipId = id;
      map.setView([ship.lat, ship.lng], 10);
      markers[id].openPopup();
      updateShipDetails(ship);
    }

    function dmsToDecimal(deg, min, sec, dir) {
      const d = Number(deg), m = Number(min), s = Number(sec);
      if ([d,m,s].some(x => isNaN(x))) return NaN;
      let dec = d + (m/60) + (s/3600);
      if (dir === "S" || dir === "W") dec = -dec;
      return dec;
    }

    function decimalToDMS(dec, isLat=true) {
      const dir = dec >= 0 ? (isLat ? "N" : "E") : (isLat ? "S" : "W");
      const absVal = Math.abs(dec);
      const deg = Math.floor(absVal);
      const minFull = (absVal - deg) * 60;
      const min = Math.floor(minFull);
      const sec = ((minFull - min) * 60).toFixed(2);
      return `${deg}° ${min}' ${sec}" ${dir}`;
    }

    function updatePositionDMS() {
      if (!currentShipId) return alert("Pilih kapal dulu dari daftar!");
      const lat = dmsToDecimal(
        document.getElementById("latDeg").value,
        document.getElementById("latMin").value,
        document.getElementById("latSec").value,
        document.getElementById("latDir").value
      );
      const lng = dmsToDecimal(
        document.getElementById("lngDeg").value,
        document.getElementById("lngMin").value,
        document.getElementById("lngSec").value,
        document.getElementById("lngDir").value
      );
      if (isNaN(lat) || isNaN(lng)) return alert("Isi semua kolom koordinat!");
      const ship = ships.find(s => s.id === currentShipId);
      ship.lat = lat; ship.lng = lng;
      markers[currentShipId].setLatLng([lat, lng]);
      map.setView([lat, lng], 10);
      updateShipDetails(ship);
      addLog(ship.id, `pindah ke ${decimalToDMS(lat, true)}, ${decimalToDMS(lng, false)}`);
    }

    function updateSuppliesManual() {
      if (!currentShipId) return alert("Pilih kapal dulu dari daftar!");
      const fuel = parseInt(document.getElementById("inputFuel").value);
      const water = parseInt(document.getElementById("inputWater").value);
      const lube = parseInt(document.getElementById("inputLube").value);
      const crew = parseInt(document.getElementById("inputCrew").value);
      if ([fuel, water, lube, crew].some(isNaN)) return alert("Isi semua data logistik dengan angka valid!");

      const ship = ships.find(s => s.id === currentShipId);
      ship.fuel = fuel; ship.water = water; ship.lube = lube; ship.crew = crew;
      updateShipDetails(ship);
      addLog(ship.id, `update logistik: BBM ${fuel}L, Air ${water}L, Pelumas ${lube}L, Personil ${crew}`);
    }

    function addActivity() {
      if (!currentShipId) return alert("Pilih kapal dulu dari daftar!");
      let activity = document.getElementById("inputActivity").value.trim();
      if (!activity) activity = document.getElementById("presetActivity").value;
      if (!activity) return alert("Isi deskripsi aktivitas dulu!");
      const ship = ships.find(s => s.id === currentShipId);
      addLog(ship.id, `Aktivitas: ${activity}`);
      document.getElementById("inputActivity").value = "";
      document.getElementById("presetActivity").value = "";
    }

    // Download log (CSV/Excel)
    function downloadLogCSV() {
      const filter = logFilter.value;
      const filteredLogs = logs.filter(l => filter === "all" || l.shipId == filter);
      if (filteredLogs.length === 0) return alert("Tidak ada log untuk diunduh!");
      let csv = "Waktu,Kapal,Aktivitas\n";
      filteredLogs.slice().reverse().forEach(l => {
        const shipName = ships.find(s => s.id === l.shipId).name;
        csv += `"${l.time}","${shipName}","${l.text}"\n`;
      });
      const uri = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
      const a = document.createElement("a");
      a.href = uri; a.download = "log_aktivitas_kapal.csv";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    function downloadLogExcel() {
      const filter = logFilter.value;
      const filteredLogs = logs.filter(l => filter === "all" || l.shipId == filter);
      if (filteredLogs.length === 0) return alert("Tidak ada log untuk diunduh!");
      const data = [["Waktu", "Kapal", "Aktivitas"]];
      filteredLogs.slice().reverse().forEach(l => {
        const shipName = ships.find(s => s.id === l.shipId).name;
        data.push([l.time, shipName, l.text]);
      });
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Log Aktivitas");
      XLSX.writeFile(wb, "log_aktivitas_kapal.xlsx");
    }

    // ==========================================
    // 6) FETCH DATA DARI GOOGLE SHEET
    // ==========================================
    function normalize(s) { return (s || "").toString().trim().toLowerCase(); }

    async function fetchData() {
      try {
        const resp = await fetch(SHEET_URL);
        const csvText = await resp.text();

        const parsed = Papa.parse(csvText, { header: true });
        const rows = parsed.data.filter(r => Object.values(r).some(v => v !== null && v !== "")); // buang baris kosong

        // Pemetaan nama kapal toleran (lowercase & trim)
        rows.forEach(row => {
          const nama = normalize(row["Nama Kapal"]);
          if (!nama) return;

          // cari kapal: match penuh atau includes dua arah
          const ship = ships.find(s => {
            const base = normalize(s.name);
            return base === nama || base.includes(nama) || nama.includes(base);
          });
          if (!ship) return;

          // Update Posisi (hanya jika valid)
          const lat = parseFloat(row["Latitude"]);
          const lng = parseFloat(row["Longitude"]);
          if (!isNaN(lat) && !isNaN(lng)) {
            ship.lat = lat; ship.lng = lng;
            markers[ship.id].setLatLng([lat, lng]);
          }

          // Update Logistik (jika ada angka)
          if (row["Bahan Bakar"]) { const v = parseInt(row["Bahan Bakar"]); if (!isNaN(v)) ship.fuel = v; }
          if (row["Air Tawar"])    { const v = parseInt(row["Air Tawar"]);    if (!isNaN(v)) ship.water = v; }
          if (row["Minyak Pelumas"]){ const v = parseInt(row["Minyak Pelumas"]); if (!isNaN(v)) ship.lube = v; }
          if (row["Jumlah Personil"]){ const v = parseInt(row["Jumlah Personil"]); if (!isNaN(v)) ship.crew = v; }

          // Update detail jika kapal sedang aktif
          if (currentShipId === ship.id) updateShipDetails(ship);

          // Tambah log Aktivitas (anti duplikasi)
          const aktivitas = (row["Aktivitas"] || "").toString().trim();
          const timestamp = (row["Timestamp"] || "").toString().trim(); // kolom otomatis Form (opsional)
          if (aktivitas) {
            const key = `${ship.id}|${timestamp}|${aktivitas}`;
            if (!seenSheetLogs.has(key)) {
              seenSheetLogs.add(key);
              addLog(ship.id, `Aktivitas (Form): ${aktivitas}`, timestamp || undefined);
            }
          }
        });

      } catch (e) {
        console.error("Gagal ambil data Sheet:", e);
      }
    }

    // Panggil awal & refresh tiap 30 detik
    fetchData();
    setInterval(fetchData, 30000);

    // Responsive map resize
    window.addEventListener("resize", () => map.invalidateSize());
    // Fokus default kapal pertama agar chart & detail terisi
    window.addEventListener("load", () => {
      map.invalidateSize();
      if (ships.length) focusShip(ships[0].id);
    });
  </script>
</body>
</html>
